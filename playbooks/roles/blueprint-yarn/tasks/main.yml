---
- name: set YARN blueprint path
  set_fact:
    blueprint_conf: "{{ role_path }}/templates/yarn-blueprint.j2"

# Extra variables not generated by Jumbo
# Lighten the blueprint for more readability
#
# - name: set variable used in hdfs-blueprint.j2
#   set_fact:
#     metrics:
#       foo: "bar"

- name: Build variables for template
  set_fact:
    YARN:
      resourcemanagers_FQDN: "{{ serv_comp_host['YARN']['RESOURCEMANAGER'] | map('regex_replace', '^(.*)$', '\\1.' + domain) | list }}"
      timeline_service_FQDN: "{{ serv_comp_host['YARN']['APP_TIMELINE_SERVER'][0]+'.'+domain if 'APP_TIMELINE_SERVER' in serv_comp_host['YARN'] else omit }}"
      container_max_memory: 1536 # TODO enhance if RAM allows it
      node_max_container: 100

- name: Compute node_max_memory
  set_fact:
    YARN_update:
      nodemanager_resource_memory: "{{ YARN.container_max_memory * YARN.node_max_container }}"

- name: Merge YARN variable
  set_fact:
    YARN: "{{ YARN | combine(YARN_update) }}"

- name: Registering service YARN
  debug:
    msg: "Added {{ blueprint_conf }}"
  changed_when: true
  notify: "add service to blueprint"

- meta: flush_handlers
